var l=Object.defineProperty;var d=(i,t,e)=>t in i?l(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var a=(i,t,e)=>(d(i,typeof t!="symbol"?t+"":t,e),e);import{j as c,s as f}from"./utils.4783f3e4.js";const S="https://api.voicerss.org/?";function p(i){try{const t=c(`tts:${i.text}`);return t?new o(t):null}catch{return null}}function y(i,t){t.audioContent&&f(`tts:${i.text}`,{audioContent:t.audioContent,timestamp:Date.now()})}function C(i=1e3*60*60*24*7){const t=Date.now();Object.keys(localStorage).forEach(e=>{if(!e.startsWith("tts:"))return;const n=c(e);n&&t-n.timestamp>=i&&localStorage.removeItem(e)})}class o{constructor(t,e){a(this,"_audio",null);this.fromAPI=t,this.nativeSynthesis=e,"speechSynthesis"in window||(this.nativeSynthesis=void 0),this.fromAPI&&(this.nativeSynthesis=void 0,this._audio=new Audio(this.fromAPI.audioContent),this._audio.onended=()=>{this._audio&&(this._audio.currentTime=0)}),this.nativeSynthesis&&(this.nativeSynthesis.onerror=()=>{throw this.nativeSynthesis=void 0,new Error("Failed to play native synthesis")})}get audioContent(){if(this.fromAPI)return this.fromAPI.audioContent;this.nativeSynthesis}play(){this._audio&&this._audio.play(),this.nativeSynthesis&&window.speechSynthesis.speak(this.nativeSynthesis)}stop(){this._audio&&(this._audio.pause(),this._audio.currentTime=0),this.nativeSynthesis&&window.speechSynthesis.cancel()}isValid(){return!!this.fromAPI||!!this.nativeSynthesis}}class _{constructor(t){a(this,"_abortController",null);this.config=t}useNativeTTS(t){if(!("SpeechSynthesisUtterance"in window))return Promise.resolve(new o);const e=new SpeechSynthesisUtterance(t.text);return new Promise(n=>{e.lang=t.languageCode??"en-US",e.rate=.5,e.voice=speechSynthesis.getVoices().find(s=>s.lang===e.lang)??null,n(new o(void 0,e))})}async synthesizeSpeech(t){const e=p(t);if(e)return e;const n=this.config;if(!n)return this.useNativeTTS(t);this._abortController&&this._abortController.abort(),this._abortController=new AbortController;const s=t.languageCode??"en-US",u=new URLSearchParams({key:n.apiKey,src:t.text,hl:s,c:t.audioEncoding??"MP3",f:"44khz_16bit_stereo",r:"-2",b64:"true"}),r=await fetch(S+u,{method:"POST",signal:this._abortController.signal});if(!r.ok)throw new Error(`Failed to synthesize speech: ${r.statusText}`);const h=new o({audioContent:await r.text()});return y(t,h),h}stop(){this._abortController&&(this._abortController.abort(),this._abortController=null)}}export{_ as T,C as c};
